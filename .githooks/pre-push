#!/bin/bash
# Pre-push hook: auto-formats code, then runs clippy and tests before allowing push

set -e

echo "Running pre-push checks..."

# Check if code is formatted
echo "Checking code formatting..."
if ! cargo fmt -- --check; then
    echo ""
    echo "ERROR: Code is not formatted. Run 'cargo fmt' and commit the changes."
    exit 1
fi

# Run clippy
echo "Running clippy..."
if ! cargo clippy -- -D warnings; then
    echo ""
    echo "ERROR: Clippy found issues. Fix them before pushing."
    exit 1
fi

# Run tests (skip db tests as they require PostgreSQL)
echo "Running tests..."
if ! cargo test --lib -- --skip db::; then
    echo ""
    echo "ERROR: Tests failed. Fix them before pushing."
    exit 1
fi

echo ""
echo "All pre-push checks passed!"
